<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Correlated Bernoulli Variables Calculator</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css" crossorigin="anonymous">
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js" integrity="sha384-XjKyOOlGwcjNTAIQHIpgOno0Hl1YQqzUOEleOLALmuqehneUG+vnGctmUb0ZY0l8" crossorigin="anonymous"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js" integrity="sha384-+VBxd3r6XgURycqtZ117nYw44OOcIax56Z4dCRWbxyPt0Koah1uHoK0o4+/RRE05" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/numeric/1.2.6/numeric.min.js"></script>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; line-height: 1.6; max-width: 800px; margin: 2rem auto; padding: 0 1rem; background-color: #fdfdfd; color: #333; }
        h2, h3 { border-bottom: 1px solid #ddd; padding-bottom: 8px; }
        table { border-collapse: collapse; width: 100%; margin-bottom: 1.5rem; text-align: center; }
        th, td { border: 1px solid #ccc; padding: 0; }
        th { background-color: #f7f7f7; font-weight: normal; }
        td.label { background-color: #f7f7f7; font-weight: bold; }
        input[type="number"] { width: 100%; height: 100%; border: 2px solid transparent; padding: 10px; box-sizing: border-box; text-align: center; font-size: 1em; background-color: transparent; color: #888; }
        input.user-input { color: black; font-weight: bold; }
        input:focus { outline: none; border-color: #007bff; }
        .error { color: #d9534f !important; border-color: #d9534f !important; }
        .correlation-container { display: flex; align-items: center; gap: 10px; margin-bottom: 1.5rem; }
        .correlation-container label { font-weight: bold; }
        .correlation-container input { flex-grow: 1; }
        button { padding: 10px 15px; border: 1px solid #ccc; background-color: #f0f0f0; cursor: pointer; border-radius: 4px; }
        button:hover { background-color: #e0e0e0; }
        details { margin-top: 2rem; border: 1px solid #ddd; border-radius: 4px; }
        summary { padding: 1rem; font-weight: bold; cursor: pointer; background-color: #f7f7f7; }
        .formulas { padding: 0 1rem 1rem 1rem; background-color: #fff; }
        #plots-container { display: flex; flex-wrap: wrap; justify-content: space-around; gap: 20px; margin-top: 2rem; }
        .plot { border: 1px solid #ddd; padding: 10px; border-radius: 4px; }
        .plot-title { text-align: center; font-weight: bold; margin-bottom: 5px; font-size: 0.9em; }
        .variable-names-container { margin-top: 1rem; margin-bottom: 1rem; display: flex; align-items: center; gap: 10px; flex-wrap: wrap; }
        .variable-names-container input { padding: 5px; border: 1px solid #ccc; border-radius: 4px; font-size: 0.9em; }
    </style>
</head>
<body>

    <h2>Correlated Bernoulli Variables Calculator</h2>
    <p>Enter exactly three values to compute the rest. User-entered values are <strong>black</strong>, calculated values are <span style="color:#888">grey</span>. Invalid states are shown in <span style="color:#d9534f">red</span>.</p>

    <p><button id="reset-button">Reset</button></p>

    <div class="variable-names-container">
        <label for="x-name">Name for variable X:</label><input type="text" id="x-name" value="X">
        <label for="y-name">Name for variable Y:</label><input type="text" id="y-name" value="Y">
    </div>

    <h3 class="katex-dynamic" data-katex-template="Joint & Marginal Probabilities: \( \mathbb{P}(\X=i, \Y=j) \)"></h3>
    <table>
        <tr>
            <th style="border:none; background:transparent;"></th>
            <th class="katex-dynamic" data-katex-template="\( \Y = 0 \)"></th>
            <th class="katex-dynamic" data-katex-template="\( \Y = 1 \)"></th>
            <th class="katex-dynamic" data-katex-template="Marginal (\( \X \))"></th>
        </tr>
        <tr>
            <td class="label katex-dynamic" data-katex-template="\( \X = 0 \)"></td>
            <td><input type="number" id="p00" step="0.01" min="0" max="1"></td>
            <td><input type="number" id="p01" step="0.01" min="0" max="1"></td>
            <td><input type="number" id="pX0" step="0.01" min="0" max="1"></td>
        </tr>
        <tr>
            <td class="label katex-dynamic" data-katex-template="\( \X = 1 \)"></td>
            <td><input type="number" id="p10" step="0.01" min="0" max="1"></td>
            <td><input type="number" id="p11" step="0.01" min="0" max="1"></td>
            <td><input type="number" id="pX" step="0.01" min="0" max="1"></td>
        </tr>
        <tr>
            <td class="katex-dynamic" data-katex-template="Marginal (\( \Y \))"></td>
            <td><input type="number" id="pY0" step="0.01" min="0" max="1"></td>
            <td><input type="number" id="pY" step="0.01" min="0" max="1"></td>
            <td style="background:#eee;">1</td>
        </tr>
    </table>

    <h3>Conditional Probabilities</h3>
    <table>
        <caption class="katex-dynamic" data-katex-template="Conditional Probabilities \( \mathbb{P}(\Y=j \mid \X=i) \)"></caption>
        <tr>
            <th style="border:none; background:transparent;"></th>
            <th class="katex-dynamic" data-katex-template="\( \Y = 0 \)"></th>
            <th class="katex-dynamic" data-katex-template="\( \Y = 1 \)"></th>
        </tr>
        <tr>
            <td class="label katex-dynamic" data-katex-template="Given \( \X = 0 \)"></td>
            <td><input type="number" id="pY0_X0" step="0.01" min="0" max="1"></td>
            <td><input type="number" id="pY1_X0" step="0.01" min="0" max="1"></td>
        </tr>
        <tr>
            <td class="label katex-dynamic" data-katex-template="Given \( \X = 1 \)"></td>
            <td><input type="number" id="pY0_X1" step="0.01" min="0" max="1"></td>
            <td><input type="number" id="pY1_X1" step="0.01" min="0" max="1"></td>
        </tr>
    </table>
    <table>
        <caption class="katex-dynamic" data-katex-template="Conditional Probabilities \( \mathbb{P}(\X=i \mid \Y=j) \)"></caption>
        <tr>
            <th style="border:none; background:transparent;"></th>
            <th class="katex-dynamic" data-katex-template="\( \X = 0 \)"></th>
            <th class="katex-dynamic" data-katex-template="\( \X = 1 \)"></th>
        </tr>
        <tr>
            <td class="label katex-dynamic" data-katex-template="Given \( \Y = 0 \)"></td>
            <td><input type="number" id="pX0_Y0" step="0.01" min="0" max="1"></td>
            <td><input type="number" id="pX1_Y0" step="0.01" min="0" max="1"></td>
        </tr>
        <tr>
            <td class="label katex-dynamic" data-katex-template="Given \( \Y = 1 \)"></td>
            <td><input type="number" id="pX0_Y1" step="0.01" min="0" max="1"></td>
            <td><input type="number" id="pX1_Y1" step="0.01" min="0" max="1"></td>
        </tr>
    </table>

    <h3>Correlation</h3>
    <div class="correlation-container">
        <label for="rho">Correlation Coefficient (\( œÅ \))</label>
        <input type="number" id="rho" step="0.01" min="-1" max="1" style='border:1px solid #ccc;'>
    </div>

    <h3>Visualizations</h3>
    <div id="plots-container"></div>

    <details>
        <summary>Formulas</summary>
        <div class="formulas" id="formula-container" data-katex-template='
        <p>In these formulas, \( p_{\X} = \mathbb{P}(\X=1) \) and \( p_{\Y} = \mathbb{P}(\Y=1) \).</p>
        <h4>Joint Distribution from Marginals and Correlation</h4>
        $$
        \begin{aligned}
        p_{11} &= p_{\X} p_{\Y} + \rho \sqrt{p_{\X}(1-p_{\X}) p_{\Y}(1-p_{\Y})} \\
        p_{10} &= p_{\X} - p_{11} \\
        p_{01} &= p_{\Y} - p_{11} \\
        p_{00} &= 1 - p_{\X} - p_{\Y} + p_{11}
        \end{aligned}
        $$

        <h4>Correlation from Joint and Marginals</h4>
        $$
        \rho = \frac{p_{11} - p_{\X} p_{\Y}}{\sqrt{p_{\X}(1-p_{\X})p_{\Y}(1-p_{\Y})}}
        $$

        <h4>Conditional Distributions</h4>
        $$
        \begin{aligned}
        \mathbb{P}(\Y=1\mid \X=1) &= \frac{p_{11}}{p_{\X}} \\
        \mathbb{P}(\Y=1\mid \X=0) &= \frac{p_{01}}{1-p_{\X}}
        \end{aligned}
        $$'>
        </div>
    </details>

<script>
document.addEventListener('DOMContentLoaded', () => {
    function updateAndRenderMath() {
        const xName = document.getElementById('x-name').value || 'X';
        const yName = document.getElementById('y-name').value || 'Y';

        document.querySelectorAll('[data-katex-template]').forEach(el => {
            el.innerHTML = el.dataset.katexTemplate;
        });

        xmacro = xName;
        if (xName.length > 1) {
            xmacro = `\\text{${xName}}`;
        }
        ymacro = yName;
        if (yName.length > 1) {
            ymacro = `\\text{${yName}}`;
        }
        renderMathInElement(document.body, {
            delimiters: [
                {left: '$$', right: '$$', display: true},
                {left: '\\[', right: '\\]', display: true},
                {left: '\\(', right: '\\)', display: false},
            ],
            macros: {
                "\\X": xmacro,
                "\\Y": ymacro,
            }
        });
    }

    const ALL_IDS = [
        'p00', 'p01', 'p10', 'p11',
        'pX', 'pX0', 'pY', 'pY0',
        'pY0_X0', 'pY1_X0', 'pY0_X1', 'pY1_X1',
        'pX0_Y0', 'pX1_Y0', 'pX0_Y1', 'pX1_Y1',
        'rho'
    ];
    const INPUT_IDS = ALL_IDS.filter(id => document.getElementById(id));
    let state = {};

    const TOLERANCE = 1e-4;

    const calcFuncs = {
        p01: vars => vars[0],
        p10: vars => vars[1],
        p11: vars => vars[2],
        p00: vars => 1 - vars[0] - vars[1] - vars[2],
        pX:  vars => vars[1] + vars[2],
        pY:  vars => vars[0] + vars[2],
        pX0: vars => 1 - (vars[1] + vars[2]),
        pY0: vars => 1 - (vars[0] + vars[2]),
        rho: vars => {
            const pX = vars[1] + vars[2];
            const pY = vars[0] + vars[2];
            const p11 = vars[2];
            const pX_var = pX * (1 - pX);
            const pY_var = pY * (1 - pY);
            if (pX_var < TOLERANCE || pY_var < TOLERANCE) return 0;
            const cov = p11 - pX * pY;
            return cov / Math.sqrt(pX_var * pY_var);
        },
        pX1_Y1: vars => { const pY = vars[0] + vars[2]; return pY < TOLERANCE ? null : vars[2] / pY; },
        pX0_Y1: vars => { const pY = vars[0] + vars[2]; return pY < TOLERANCE ? null : vars[0] / pY; },
        pX1_Y0: vars => { const pY = vars[0] + vars[2]; return (1 - pY) < TOLERANCE ? null : vars[1] / (1 - pY); },
        pX0_Y0: vars => { const pY = vars[0] + vars[2]; const p00 = 1 - vars[0] - vars[1] - vars[2]; return (1 - pY) < TOLERANCE ? null : p00 / (1 - pY); },
        pY1_X1: vars => { const pX = vars[1] + vars[2]; return pX < TOLERANCE ? null : vars[2] / pX; },
        pY0_X1: vars => { const pX = vars[1] + vars[2]; return pX < TOLERANCE ? null : vars[1] / pX; },
        pY1_X0: vars => { const pX = vars[1] + vars[2]; return (1 - pX) < TOLERANCE ? null : vars[0] / (1 - pX); },
        pY0_X0: vars => { const pX = vars[1] + vars[2]; const p00 = 1 - vars[0] - vars[1] - vars[2]; return (1 - pX) < TOLERANCE ? null : p00 / (1 - pX); }
    };

    function createState() {
        const newState = {};
        INPUT_IDS.forEach(id => {
            newState[id] = { value: null, isUserInput: false };
        });
        return newState;
    }

    function resetState() {
        state = createState();
        document.getElementById('x-name').value = 'X';
        document.getElementById('y-name').value = 'Y';
        updateAndRenderMath();
        render();
    }

    function handleInput(e) {
        console.log(`--- handleInput triggered for id: ${e.target.id} ---`);
        const id = e.target.id;
        const value = e.target.value === '' ? null : parseFloat(e.target.value);

        const userInputs = Object.values(state).filter(s => s.isUserInput);
        if (userInputs.length === 0 && value !== null) {
            console.log("First input detected, resetting state.");
            state = createState();
        }

        state[id].value = value;
        state[id].isUserInput = (value !== null);
        console.log(`State for ${id} updated:`, state[id]);

        const complementary = { pX: 'pX0', pX0: 'pX', pY: 'pY0', pY0: 'pY', pY0_X0: 'pY1_X0', pY1_X0: 'pY0_X0', pY0_X1: 'pY1_X1', pY1_X1: 'pY0_X1', pX0_Y0: 'pX1_Y0', pX1_Y0: 'pX0_Y0', pX0_Y1: 'pX1_Y1', pX1_Y1: 'pX0_Y1' };
        if (complementary[id] && value !== null && value >= 0 && value <= 1) {
            const complementId = complementary[id];
            state[complementId].value = 1 - value;
            state[complementId].isUserInput = false;
            console.log(`Complementary field ${complementId} updated to ${state[complementId].value}`);
        }

        calculateAll(id);
    }

    function calculateAll(activeElementId = null) {
        console.log("--- calculateAll called ---");
        for (const id in state) {
            if (!state[id].isUserInput) {
                state[id].value = null;
            }
        }
        console.log("Cleared non-user values.");

        const solution = solve();
        console.log("Solver result:", solution);

        if (solution.success) {
            console.log("Solution successful, propagating values.");
            propagate(solution.vars);
        } else {
            console.log("Solution failed or not attempted.");
        }

        const validationResult = validate();
        const userInputsCount = Object.values(state).filter(s => s.isUserInput && s.value !== null).length;
        const isError = (!solution.success && userInputsCount >= 3) || (solution.success && validationResult);
        console.log(`Validation result: ${validationResult}, Final isError flag: ${isError}`);
        render(isError, activeElementId);
    }

    function solve() {
        console.log("--- solve called ---");
        const userInputs = Object.entries(state).filter(([, s]) => s.isUserInput && s.value !== null);

        console.log(`Found ${userInputs.length} user inputs.`);
        if (userInputs.length !== 3) {
            console.log("Exiting solve: Not exactly 3 inputs.");
            return { success: false };
        }

        console.log("Constraints for solver:", userInputs.map(([id, s]) => `${id}: ${s.value}`));

        const objectiveFunction = (vars) => {
            let totalError = 0;
            const [p01, p10, p11] = vars;
            const p00 = 1 - p01 - p10 - p11;

            if (p00 < 0) totalError += 1e6 * p00 * p00;
            if (p01 < 0) totalError += 1e6 * p01 * p01;
            if (p10 < 0) totalError += 1e6 * p10 * p10;
            if (p11 < 0) totalError += 1e6 * p11 * p11;

            for (const [id, s] of userInputs) {
                if (calcFuncs[id]) {
                    const calculatedValue = calcFuncs[id](vars);
                    if (calculatedValue !== null && isFinite(calculatedValue)) {
                        totalError += Math.pow(calculatedValue - s.value, 2);
                    }
                }
            }
            return totalError;
        };

        const MAX_ITERATIONS = 10;
        let result;
        let success = false;

        for (let i = 0; i < MAX_ITERATIONS; i++) {
            const initialGuess = [Math.random(), Math.random(), Math.random()];
            console.log(`Running numerical solver, attempt ${i + 1}/${MAX_ITERATIONS}, initial guess:`, initialGuess);
            result = numeric.uncmin(objectiveFunction, initialGuess);

            success = result.f < 1e-6 && Array.isArray(result.solution);
            if (success) {
                console.log(`Solver found a solution with error ${result.f} in iteration ${i}.`);
                break;
            }
        }

        if (!success) {
            console.log(`Solver failed to find a solution after ${MAX_ITERATIONS} attempts. Best error: ${result.f}.`);
        }

        console.log("Raw solver result object:", result);
        console.log(`Solver finished. Final error (f): ${result.f}, Is solution an array: ${Array.isArray(result.solution)}, Success: ${success}`);
        return { success: success, vars: result.solution };
    }

    function propagate(vars) {
        console.log("--- propagate called with vars:", vars);
        const [p01, p10, p11] = vars;
        const p00 = 1 - p01 - p10 - p11;

        state.p00.value = p00;
        state.p01.value = p01;
        state.p10.value = p10;
        state.p11.value = p11;

        for (const id in state) {
            if (state[id].value === null && calcFuncs[id]) {
                state[id].value = calcFuncs[id](vars);
            }
        }
        console.log("Propagation complete. New state:", state);
    }

    function validate() {
        console.log("--- validate called ---");
        let hasError = false;
        for (const id in state) {
            const val = state[id].value;
            if (val === null) continue;

            let isFieldInvalid = false;
            if (id === 'rho') {
                if (val < -1 - TOLERANCE || val > 1 + TOLERANCE) isFieldInvalid = true;
            } else {
                if (val < 0 - TOLERANCE || val > 1 + TOLERANCE) isFieldInvalid = true;
            }
            if (isNaN(val)) isFieldInvalid = true;

            if (isFieldInvalid) {
                console.log(`Validation failed for ${id}: value is ${val}`);
                hasError = true;
            }
        }
        console.log(`Validation finished. hasError: ${hasError}`);
        return hasError;
    }

    function render(isError = false, activeElementId = null) {
        console.log(`--- render called, isError: ${isError} ---`);
        const userInputsCount = Object.values(state).filter(s => s.isUserInput && s.value !== null).length;
        const showError = isError && userInputsCount >= 3;
        console.log(`User inputs: ${userInputsCount}, showError flag: ${showError}`);

        INPUT_IDS.forEach(id => {
            const el = document.getElementById(id);
            if (id === activeElementId) {
                el.classList.toggle('error', showError);
                return;
            }

            const s = state[id];

            if (s.value !== null && !isNaN(s.value)) {
                el.value = parseFloat(s.value).toFixed(3);
            } else {
                el.value = '';
            }

            el.classList.toggle('user-input', s.isUserInput);
            el.classList.toggle('error', showError);
        });
        renderPlots(state);
    }

    function renderPlots(state) {
        const xName = document.getElementById('x-name').value || 'X';
        const yName = document.getElementById('y-name').value || 'Y';

        const container = d3.select("#plots-container");
        container.html(""); // Clear previous plots

        const plotData = [
            { id: 'joint', title: 'Joint Probabilities', data: ['p00', 'p01', 'p10', 'p11'] },
            { id: 'marginal-x', title: `Marginal P(${xName})`, data: ['pX0', 'pX'] },
            { id: 'marginal-y', title: `Marginal P(${yName})`, data: ['pY0', 'pY'] },
            { id: 'cond-y-x0', title: `P(${yName}|${xName}=0)`, data: ['pY0_X0', 'pY1_X0'] },
            { id: 'cond-y-x1', title: `P(${yName}|${xName}=1)`, data: ['pY0_X1', 'pY1_X1'] },
            { id: 'cond-x-y0', title: `P(${xName}|${yName}=0)`, data: ['pX0_Y0', 'pX1_Y0'] },
            { id: 'cond-x-y1', title: `P(${xName}|${yName}=1)`, data: ['pX0_Y1', 'pX1_Y1'] }
        ];

        const labelMap = {
            'p00': `${xName}=0,${yName}=0`, 'p01': `${xName}=0,${yName}=1`, 'p10': `${xName}=1,${yName}=0`, 'p11': `${xName}=1,${yName}=1`,
            'pX0': `${xName}=0`, 'pX': `${xName}=1`,
            'pY0': `${yName}=0`, 'pY': `${yName}=1`,
            'pY0_X0': `${yName}=0`, 'pY1_X0': `${yName}=1`,
            'pY0_X1': `${yName}=0`, 'pY1_X1': `${yName}=1`,
            'pX0_Y0': `${xName}=0`, 'pX1_Y0': `${xName}=1`,
            'pX0_Y1': `${xName}=0`, 'pX1_Y1': `${xName}=1`
        };

        const hasValues = Object.values(state).some(s => s.value !== null);
        if (!hasValues) {
            container.html("(none)");
            return;
        }

        plotData.forEach(plot => {
            const data = plot.data.map(id => ({
                id: id,
                label: labelMap[id] || id,
                value: state[id].value,
                isUserInput: state[id].isUserInput
            })).filter(d => d.value !== null && !isNaN(d.value));

            if (data.length > 0) {
                createBarChart(plot.id, plot.title, data);
            }
        });

        createCorrelationPlot(state);

        function createBarChart(id, title, data) {
            const plotContainer = container.append("div")
                .attr("class", "plot")
                .attr("id", `plot-${id}`);

            plotContainer.append("div")
                .attr("class", "plot-title")
                .text(title);

            const margin = {top: 20, right: 10, bottom: 40, left: 40};
            const width = 200 - margin.left - margin.right;
            const height = 150 - margin.top - margin.bottom;

            const svg = plotContainer.append("svg")
                .attr("width", width + margin.left + margin.right)
                .attr("height", height + margin.top + margin.bottom)
              .append("g")
                .attr("transform", `translate(${margin.left},${margin.top})`);

            const x = d3.scaleBand()
                .range([0, width])
                .domain(data.map(d => d.label))
                .padding(0.2);

            svg.append("g")
                .attr("transform", `translate(0,${height})`)
                .call(d3.axisBottom(x))
                .selectAll("text")
                .attr("transform", "translate(-10,0)rotate(-45)")
                .style("text-anchor", "end");

            const y = d3.scaleLinear()
                .domain([0, 1])
                .range([height, 0]);

            svg.append("g")
                .call(d3.axisLeft(y));

            svg.selectAll("rect")
                .data(data)
                .enter()
                .append("rect")
                .attr("x", d => x(d.label))
                .attr("y", d => y(d.value))
                .attr("width", x.bandwidth())
                .attr("height", d => height - y(d.value))
                .attr("fill", d => d.isUserInput ? "#a1d99b" : "#9ecae1"); // light green for user, light blue for calculated

            svg.selectAll(".bar-label")
                .data(data)
                .enter()
                .append("text")
                .attr("x", d => x(d.label) + x.bandwidth() / 2)
                .attr("y", d => y(d.value) - 5)
                .attr("text-anchor", "middle")
                .style("font-size", "10px")
                .text(d => d.value.toFixed(3));
        }

        function createCorrelationPlot(state) {
            const jointProbs = [
                { x: 0, y: 0, p: state.p00.value, isUserInput: state.p00.isUserInput },
                { x: 1, y: 0, p: state.p10.value, isUserInput: state.p10.isUserInput },
                { x: 0, y: 1, p: state.p01.value, isUserInput: state.p01.isUserInput },
                { x: 1, y: 1, p: state.p11.value, isUserInput: state.p11.isUserInput }
            ].filter(d => d.p !== null && !isNaN(d.p) && d.p >= 0);

            if (jointProbs.length !== 4) return;

            const container = d3.select("#plots-container");
            const plotContainer = container.append("div")
                .attr("class", "plot")
                .attr("id", "plot-correlation");

            plotContainer.append("div")
                .attr("class", "plot-title")
                .text("Joint Distribution & Correlation");

            const margin = { top: 20, right: 20, bottom: 40, left: 40 };
            const width = 200 - margin.left - margin.right;
            const height = 200 - margin.top - margin.bottom;

            const svg = plotContainer.append("svg")
                .attr("width", width + margin.left + margin.right)
                .attr("height", height + margin.top + margin.bottom)
                .append("g")
                .attr("transform", `translate(${margin.left},${margin.top})`);

            const x = d3.scaleLinear().domain([-0.2, 1.2]).range([0, width]);
            const y = d3.scaleLinear().domain([-0.2, 1.2]).range([height, 0]);

            svg.append("g").attr("transform", `translate(0,${height})`).call(d3.axisBottom(x).ticks(1).tickFormat(d3.format("d")));
            svg.append("g").call(d3.axisLeft(y).ticks(1).tickFormat(d3.format("d")));

            const xName = document.getElementById('x-name').value || 'X';
            const yName = document.getElementById('y-name').value || 'Y';
            svg.append("text").attr("x", width / 2).attr("y", height + margin.bottom - 5).style("text-anchor", "middle").text(xName);
            svg.append("text").attr("transform", "rotate(-90)").attr("y", 0 - margin.left).attr("x", 0 - (height / 2)).attr("dy", "1em").style("text-anchor", "middle").text(yName);

            const r = d3.scaleSqrt().domain([0, 1]).range([0, 30]);

            svg.selectAll("circle")
                .data(jointProbs)
                .enter()
                .append("circle")
                .attr("cx", d => x(d.x))
                .attr("cy", d => y(d.y))
                .attr("r", d => r(d.p))
                .attr("fill", d => d.isUserInput ? "#a1d99b" : "#9ecae1")
                .attr("opacity", 0.8);

            // Regression line
            const pX = state.pX.value;
            const pY = state.pY.value;
            const p11 = state.p11.value;
            if (pX === null || pY === null || p11 === null) return;

            const pX_var = pX * (1 - pX);
            if (Math.abs(pX_var) > 1e-9) {
                const cov = p11 - pX * pY;
                const slope = cov / pX_var;
                const intercept = pY - slope * pX;

                svg.append("line")
                    .attr("x1", x(x.domain()[0]))
                    .attr("y1", y(intercept + slope * x.domain()[0]))
                    .attr("x2", x(x.domain()[1]))
                    .attr("y2", y(intercept + slope * x.domain()[1]))
                    .attr("stroke", "#d9534f")
                    .attr("stroke-width", 2);
            }
        }
    }

    function setupListeners() {
        INPUT_IDS.forEach(id => {
            const el = document.getElementById(id);
            el.addEventListener('input', handleInput);
            el.addEventListener('blur', () => calculateAll());
        });
        document.getElementById('reset-button').addEventListener('click', resetState);
        document.getElementById('x-name').addEventListener('blur', () => {
            updateAndRenderMath();
            render();
        });
        document.getElementById('y-name').addEventListener('blur', () => {
            updateAndRenderMath();
            render();
        });
    }

    resetState();
    setupListeners();
    updateAndRenderMath();
});
</script>

</body>
</html>
